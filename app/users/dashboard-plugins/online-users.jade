.dashboard-plugin( style='width: 40%' )
  .dashboard-plugin-header
    .name=t('User statistics')

  .dashboard-plugin-body
    #online-users-chart( style='width: 100%; height: 150px')

    script(type='text/javascript')
      var d = !{JSON.stringify(users.map( function( user ){ return [user.lastRequest.createdAt.getTime()})   [[moment().subtract('d',2).toDate().getTime(), 2], [moment().subtract('d', 1).toDate().getTime(), 15], [moment().toDate().getTime(), 22]];
      for (var i = 0; i < d.length; ++i) 
        d[i][0] += 60 * 60 * 1000;
      var options = {
        series: {
          lines: {
            show: true
          },
          points: {
            show: true
          }
        },
        xaxis: {
          mode: "time",
          tickLength: 5
        },
        selection: {
          mode: "x"
        },
        grid: {
          markings: weekendAreas,
          hoverable: true,
          clickable: true
        }
      };

      $.plot("#online-users-chart", [d], options );
      
      $('#online-users-chart').on('plothover', function (event, pos, item) {
        if( !item ) return $('.chart-tooltip').remove();
        console.log(item);
        showTooltip( item.pageX, item.pageY, item.datapoint[1] );
      });

      function weekendAreas(axes) {
        var markings = [],
          d = new Date(axes.xaxis.min);

        // go to the first Saturday

        d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
        d.setUTCSeconds(0);
        d.setUTCMinutes(0);
        d.setUTCHours(0);

        var i = d.getTime();

        // when we don't set yaxis, the rectangle automatically
        // extends to infinity upwards and downwards

        do {
          markings.push({ xaxis: { from: i, to: i + 2 * 24 * 60 * 60 * 1000 } });
          i += 7 * 24 * 60 * 60 * 1000;
        } while (i < axes.xaxis.max);

        return markings;
      }

      function showTooltip(x, y, contents) {
        $("<div class='chart-tooltip'>" + contents + "</div>").css({
          position: "absolute",
          display: "none",
          top: y + 5,
          left: x + 5,
          border: "1px solid #fdd",
          padding: "2px",
          "background-color": "#fee",
          opacity: 0.80
        }).appendTo("body").fadeIn(200);
      }

  .dashboard-plugin-footer
    =t('as at')
    |&nbsp;
    =moment().format('dddd, DD. MMMM YYYY HH:mm')
